<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Todos - Second Brain</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='fav.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header class="app-bar">
        <a href="{{ url_for('dashboard') }}" class="app-bar-link">
            <span class="logo">üß†</span>
            <span class="app-name">Second Brain</span>
        </a>
        <nav class="app-nav">
            <a href="{{ url_for('dashboard') }}" class="nav-link">üè† Dashboard</a>
            <a href="{{ url_for('todays_tasks') }}" class="nav-link">üìÖ Today's Tasks</a>
            <a href="{{ url_for('create_todo') }}" class="nav-link">‚ûï Create Todo</a>
            <a href="{{ url_for('all_todos') }}" class="nav-link active">üìã All Todos</a>
            <a href="{{ url_for('create_experience') }}" class="nav-link">üí° Past Experience</a>
            <a href="{{ url_for('view_experiences') }}" class="nav-link">üìö All Experiences</a>
        </nav>
    </header>

    <div class="full-screen-container">
        <main class="todos-main">
            <div class="todos-toolbar">
                <h2>All Todos</h2>
                <div class="toolbar-actions">
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="statusFilter" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="in-queue" {% if current_status == 'in-queue' %}selected{% endif %}>In Queue</option>
                            <option value="ready" {% if current_status == 'ready' %}selected{% endif %}>Ready</option>
                            <option value="in-progress" {% if current_status == 'in-progress' %}selected{% endif %}>In Progress</option>
                            <option value="hold" {% if current_status == 'hold' %}selected{% endif %}>Hold</option>
                            <option value="done" {% if current_status == 'done' %}selected{% endif %}>Done</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="includeDone" {% if include_done == 'true' %}checked{% endif %} onchange="applyFilters()">
                            Include Done
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>From Date:</label>
                        <input type="date" id="fromDate" value="{{ from_date or '' }}" onchange="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>To Date:</label>
                        <input type="date" id="toDate" value="{{ to_date or '' }}" onchange="applyFilters()">
                    </div>
                    <a href="{{ url_for('create_todo') }}" class="btn btn-primary">+ New Todo</a>
                </div>
            </div>

            {% if todos %}
                <div class="summary-stats">
                    <div class="stat-box stat-total">
                        <span class="stat-label">Total Entries:</span>
                        <span class="stat-value">{{ todos|length }}</span>
                    </div>
                    <div class="stat-group">
                        <div class="stat-box stat-in-progress">
                            <span class="stat-label">In Progress:</span>
                            <span class="stat-value">{{ todos|selectattr('status', 'equalto', 'in-progress')|list|length }}</span>
                        </div>
                        <div class="stat-box stat-ready">
                            <span class="stat-label">Ready:</span>
                            <span class="stat-value">{{ todos|selectattr('status', 'equalto', 'ready')|list|length }}</span>
                        </div>
                        <div class="stat-box stat-hold">
                            <span class="stat-label">Hold:</span>
                            <span class="stat-value">{{ todos|selectattr('status', 'equalto', 'hold')|list|length }}</span>
                        </div>
                        <div class="stat-box stat-critical">
                            <span class="stat-label">Critical:</span>
                            <span class="stat-value">{{ todos|selectattr('priority', 'equalto', 'Critical')|list|length }}</span>
                        </div>
                    </div>
                </div>

                <div class="todos-table">
                    <table>
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th class="sortable" onclick="sortBy('title')">
                                    Title
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'title' and current_order == 'ASC' else '‚Üì' if current_sort == 'title' else '‚Üï' }}</span>
                                </th>
                                <th class="sortable" onclick="sortBy('status')">
                                    Status
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'status' and current_order == 'ASC' else '‚Üì' if current_sort == 'status' else '‚Üï' }}</span>
                                </th>
                                <th class="sortable" onclick="sortBy('priority')">
                                    Priority
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'priority' and current_order == 'ASC' else '‚Üì' if current_sort == 'priority' else '‚Üï' }}</span>
                                </th>
                                <th class="sortable" onclick="sortBy('created_at')">
                                    Created Date
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'created_at' and current_order == 'ASC' else '‚Üì' if current_sort == 'created_at' else '‚Üï' }}</span>
                                </th>
                                <th class="sortable" onclick="sortBy('start_date')">
                                    Work Start
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'start_date' and current_order == 'ASC' else '‚Üì' if current_sort == 'start_date' else '‚Üï' }}</span>
                                </th>
                                <th class="sortable" onclick="sortBy('end_date')">
                                    Work End
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'end_date' and current_order == 'ASC' else '‚Üì' if current_sort == 'end_date' else '‚Üï' }}</span>
                                </th>
                                <th class="sortable" onclick="sortBy('target_date')">
                                    Target Date
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'target_date' and current_order == 'ASC' else '‚Üì' if current_sort == 'target_date' else '‚Üï' }}</span>
                                </th>
                                <th class="sortable" onclick="sortBy('remaining_days')">
                                    Remaining Days
                                    <span class="sort-arrow">{{ '‚Üë' if current_sort == 'remaining_days' and current_order == 'ASC' else '‚Üì' if current_sort == 'remaining_days' else '‚Üï' }}</span>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for todo in todos %}
                            <tr class="todo-row" onclick="window.location.href='{{ url_for('view_todo', id=todo['id']) }}'">
                                <td>{{ loop.index }}</td>
                                <td class="todo-title">{{ todo['title'] }}</td>
                                <td>
                                    <select class="status-dropdown status-{{ todo['status'] }}" 
                                            onclick="event.stopPropagation()" 
                                            onchange="updateStatus({{ todo['id'] }}, this.value)">
                                        <option value="in-queue" {% if todo['status'] == 'in-queue' %}selected{% endif %}>In Queue</option>
                                        <option value="ready" {% if todo['status'] == 'ready' %}selected{% endif %}>Ready</option>
                                        <option value="in-progress" {% if todo['status'] == 'in-progress' %}selected{% endif %}>In Progress</option>
                                        <option value="hold" {% if todo['status'] == 'hold' %}selected{% endif %}>Hold</option>
                                        <option value="done" {% if todo['status'] == 'done' %}selected{% endif %}>Done</option>
                                    </select>
                                </td>
                                <td>
                                    <span class="priority-badge priority-{{ todo['priority'] }}">{{ todo['priority'] }}</span>
                                </td>
                                <td class="todo-date">{{ todo['created_at'] }}</td>
                                <td class="todo-date">
                                    {% if todo['start_date'] %}
                                        {{ todo['start_date'] }}
                                    {% else %}
                                        <span style="color: #9ca3af;">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="todo-date">
                                    {% if todo['end_date'] %}
                                        {{ todo['end_date'] }}
                                    {% else %}
                                        <span style="color: #9ca3af;">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="todo-date">
                                    {% if todo['target_date'] %}
                                        {{ todo['target_date'] }}
                                    {% else %}
                                        <span style="color: #9ca3af;">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="remaining-days" data-target-date="{{ todo['target_date'] or '' }}">
                                    <span style="color: #9ca3af;">‚Äî</span>
                                </td>
                                <td class="todo-actions" onclick="event.stopPropagation()">
                                    <a href="{{ url_for('view_todo', id=todo['id']) }}" 
                                       class="btn-icon btn-view" 
                                       title="View">üëÅÔ∏è</a>
                                    <a href="{{ url_for('edit_todo', id=todo['id']) }}" 
                                       class="btn-icon btn-edit" 
                                       title="Edit">‚úèÔ∏è</a>
                                    <a href="{{ url_for('delete_todo', id=todo['id']) }}" 
                                       class="btn-icon btn-delete" 
                                       title="Delete" 
                                       onclick="return confirm('Are you sure you want to delete this todo?')">üóë</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <p>No todos found. Create your first one!</p>
                    <a href="{{ url_for('create_todo') }}" class="btn btn-primary">Create Todo</a>
                </div>
            {% endif %}
        </main>
    </div>

    <script>
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function calculateRemainingDays(targetDateStr) {
            if (!targetDateStr) return null;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const targetDate = new Date(targetDateStr);
            targetDate.setHours(0, 0, 0, 0);
            
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        function formatRemainingDays(days) {
            if (days === null) return '‚Äî';
            
            if (days < 0) {
                const absDays = Math.abs(days);
                return `<span style="color: #ef4444;">${absDays} ${absDays === 1 ? 'day' : 'days'} overdue</span>`;
            } else if (days === 0) {
                return '<span style="color: #f59e0b;">Today</span>';
            } else if (days === 1) {
                return '<span style="color: #10b981;">1 day</span>';
            } else {
                return `<span style="color: #10b981;">${days} days</span>`;
            }
        }

        function sortBy(column) {
            const currentSort = '{{ current_sort }}';
            const currentOrder = '{{ current_order }}';
            
            let newOrder = 'DESC';
            if (currentSort === column) {
                newOrder = currentOrder === 'DESC' ? 'ASC' : 'DESC';
            }
            
            const status = document.getElementById('statusFilter').value;
            const includeDone = document.getElementById('includeDone').checked;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            let url = '{{ url_for("all_todos") }}?';
            if (status) url += 'status=' + status + '&';
            url += 'include_done=' + includeDone + '&';
            if (fromDate) url += 'from_date=' + fromDate + '&';
            if (toDate) url += 'to_date=' + toDate + '&';
            url += 'sort=' + column + '&order=' + newOrder;
            
            window.location.href = url;
        }

        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const includeDone = document.getElementById('includeDone').checked;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const currentSort = '{{ current_sort or "created_at" }}';
            const currentOrder = '{{ current_order or "DESC" }}';
            
            let url = '{{ url_for("all_todos") }}?';
            if (status) url += 'status=' + status + '&';
            url += 'include_done=' + includeDone + '&';
            if (fromDate) url += 'from_date=' + fromDate + '&';
            if (toDate) url += 'to_date=' + toDate + '&';
            url += 'sort=' + currentSort + '&order=' + currentOrder;
            
            window.location.href = url;
        }

        function updateStatus(id, status) {
            // Ask for confirmation when marking as done
            if (status === 'done') {
                if (!confirm('Mark this task as Done?')) {
                    // Reload to reset the dropdown
                    location.reload();
                    return;
                }
            }
            
            window.location.href = '{{ url_for("update_status", id=0, status="") }}'.replace('/0/', '/' + id + '/').replace(/\/[^\/]*$/, '/' + status);
        }

        // Format all dates and calculate remaining days on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Format dates
            document.querySelectorAll('.todo-date').forEach(function(cell) {
                const dateText = cell.textContent.trim();
                if (dateText && dateText !== '‚Äî' && dateText !== 'Not set') {
                    const formatted = formatDate(dateText);
                    if (formatted) cell.textContent = formatted;
                }
            });

            // Calculate remaining days
            document.querySelectorAll('.remaining-days').forEach(function(cell) {
                const targetDate = cell.getAttribute('data-target-date');
                if (targetDate) {
                    const days = calculateRemainingDays(targetDate);
                    cell.innerHTML = formatRemainingDays(days);
                } else {
                    cell.innerHTML = '<span style="color: #9ca3af;">‚Äî</span>';
                }
            });
        });
    </script>
</body>
</html>
